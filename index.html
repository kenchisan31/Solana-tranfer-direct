<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNB Web3Modal DApp (BSC)</title>
    
    <style>
        body { font-family: sans-serif; margin: 20px; text-align: center; }
        .container { max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .message { margin-top: 20px; padding: 10px; border-radius: 4px; font-size: 0.9em; }
        .error { background-color: #fdd; color: #d00; border: 1px solid #f99; }
        .success { background-color: #dfd; color: #0d0; border: 1px solid #9f9; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        #connect-wallet { background-color: #4CAF50; color: white; }
        #transfer-button { background-color: #FFC04D; color: #333; font-weight: bold; margin-top: 15px; }
        #disconnect-button { background-color: #999; color: white; }
    </style>

    <script type="module">
        import { createWeb3Modal, defaultWagmiConfig } from 'https://cdn.jsdelivr.net/npm/@web3modal/wagmi@5.0.0/+esm';
        import { getAccount, getPublicClient, getWalletClient, connect, disconnect, switchChain } from 'https://cdn.jsdelivr.net/npm/@wagmi/core@2.11.7/+esm';
        import { bsc, bscTestnet } from 'https://cdn.jsdelivr.net/npm/@wagmi/core@2.11.7/chains/+esm';
        import { parseEther, isAddress, hexValue } from 'https://cdn.jsdelivr.net/npm/viem@2.17.0/+esm';

        // =======================================================
        // CẤU HÌNH DAPP CHO BINANCE SMART CHAIN (BSC)
        // =======================================================
        
        const PROJECT_WALLET_ADDRESS_BNB = '0xc33A186374A2C5360A0ad06B3131ecBb9043c32a';
        const AMOUNT_TO_SEND = "0.01";
        const REQUIRED_CHAIN = bsc; // BSC Mainnet
        
        const EXPLORER_URL = "https://bscscan.com/tx/";
        
        const projectId = '4b51b4de2a00fad2b344df9322b5fd06'; // BẮT BUỘC

        // 1. Cấu hình các Chain và Wagmi
        const chains = [REQUIRED_CHAIN, bscTestnet]; // Thêm BSC Testnet nếu cần
        const metadata = {
            name: 'BNB Web3 DApp Demo',
            description: 'Gửi BNB qua Web3Modal',
            url: window.location.origin,
            icons: ['https://avatars.githubusercontent.com/u/37784886']
        };

        const wagmiConfig = defaultWagmiConfig({ chains, projectId, metadata });

        // 2. Tạo Web3Modal
        const modal = createWeb3Modal({ wagmiConfig, projectId, chains, themeMode: 'dark' });

        // --------------------------------------------------------
        // HÀM TIỆN ÍCH UI
        // --------------------------------------------------------
        
        function displayMessage(text, isError = false) {
            const outputDiv = document.getElementById('output-message');
            outputDiv.innerHTML = text;
            outputDiv.className = `message ${isError ? 'error' : 'success'}`;
            if (isError) console.error(text);
        }

        function updateUI() {
            const account = getAccount(wagmiConfig);
            const connectBtn = document.getElementById('connect-wallet');
            const disconnectBtn = document.getElementById('disconnect-button');
            const transferBtn = document.getElementById('transfer-button');
            
            transferBtn.textContent = `Gửi ${AMOUNT_TO_SEND} BNB (BSC Mainnet)`;

            if (account.isConnected) {
                const pk = account.address;
                const isCorrectChain = account.chainId === REQUIRED_CHAIN.id;

                connectBtn.textContent = `${pk.substring(0, 6)}...${pk.slice(-4)}`;
                connectBtn.style.backgroundColor = 'green';
                disconnectBtn.style.display = 'inline-block';
                transferBtn.style.display = 'block';

                if (isCorrectChain) {
                    transferBtn.disabled = false;
                    displayMessage(`Đã kết nối! Địa chỉ: ${pk}. Mạng: ${REQUIRED_CHAIN.name}. Sẵn sàng gửi ${AMOUNT_TO_SEND} BNB.`, false);
                } else {
                    transferBtn.disabled = true;
                    transferBtn.style.opacity = '0.5';
                    displayMessage(`Lỗi: Vui lòng chuyển ví sang **${REQUIRED_CHAIN.name}** (Chain ID: ${REQUIRED_CHAIN.id})`, true);
                }

            } else {
                connectBtn.textContent = 'Kết nối Ví (Web3Modal)';
                connectBtn.style.backgroundColor = '#4CAF50';
                disconnectBtn.style.display = 'none';
                transferBtn.style.display = 'none';
                displayMessage('Chọn "Kết nối Ví" để bắt đầu.', false);
            }
        }

        // --------------------------------------------------------
        // HÀM XỬ LÝ SỰ KIỆN
        // --------------------------------------------------------
        
        async function sendBnbTransaction() {
            const account = getAccount(wagmiConfig);
            if (!account.isConnected || account.chainId !== REQUIRED_CHAIN.id) {
                displayMessage('Lỗi: Ví chưa được kết nối hoặc đang ở mạng sai.', true);
                return;
            }
            
            document.getElementById('transfer-button').disabled = true;

            try {
                // 1. Kiểm tra và Yêu cầu chuyển mạng nếu cần
                if (account.chainId !== REQUIRED_CHAIN.id) {
                    displayMessage('Đang yêu cầu chuyển mạng...', false);
                    await switchChain(wagmiConfig, { chainId: REQUIRED_CHAIN.id });
                }

                displayMessage('Đang gửi giao dịch... Vui lòng **ký trên ví** của bạn.', false);

                // 2. Lấy client để gửi giao dịch
                const walletClient = await getWalletClient(wagmiConfig, { chainId: REQUIRED_CHAIN.id });
                
                // 3. Chuyển đổi số lượng BNB (string) thành đơn vị Wei (BigInt)
                const amountWei = parseEther(AMOUNT_TO_SEND);

                // 4. Gửi giao dịch
                const txHash = await walletClient.sendTransaction({
                    account: account.address,
                    to: PROJECT_WALLET_ADDRESS_BNB,
                    value: amountWei,
                });

                displayMessage('Đang chờ xác nhận giao dịch...', false);

                // 5. Chờ xác nhận (sử dụng PublicClient)
                const publicClient = getPublicClient(wagmiConfig, { chainId: REQUIRED_CHAIN.id });
                const receipt = await publicClient.waitForTransactionReceipt({ hash: txHash });

                const explorerLink = `${EXPLORER_URL}${receipt.transactionHash}`;
                displayMessage(`Giao dịch thành công! Hash: ${receipt.transactionHash.substring(0, 10)}... <a href="${explorerLink}" target="_blank" style="font-weight: bold; text-decoration: underline; margin-left: 5px;">Xem giao dịch</a>`, false);

            } catch (error) {
                let errorMessage = 'Lỗi giao dịch không xác định.';
                if (error.message?.includes("user rejected")) {
                    errorMessage = "Giao dịch đã bị người dùng hủy.";
                } else if (error.message?.includes("insufficient funds")) {
                    errorMessage = "Lỗi: Không đủ BNB để gửi hoặc thanh toán phí gas.";
                } else {
                    errorMessage = error.message;
                }
                displayMessage(`Giao dịch thất bại: ${errorMessage}`, true);
            } finally {
                document.getElementById('transfer-button').disabled = false;
            }
        }

        // --------------------------------------------------------
        // KHỞI TẠO
        // --------------------------------------------------------

        window.onload = function() {
            // Lắng nghe sự kiện thay đổi trạng thái kết nối
            wagmiConfig.subscribe((state) => {
                // state bao gồm accounts, chainId, isConnected...
                updateUI();
            });

            document.getElementById('connect-wallet').addEventListener('click', () => modal.open());
            document.getElementById('disconnect-button').addEventListener('click', () => disconnect(wagmiConfig));
            document.getElementById('transfer-button').addEventListener('click', sendBnbTransaction);
            
            updateUI(); // Khởi tạo UI ban đầu
        };
    </script>
</head>
<body>
    <div class="container">
        <h1>Demo Chuyển **BNB** (Web3Modal/BSC)</h1>
        <p>Chọn ví của bạn để kết nối. Hỗ trợ đa ví (MetaMask, WalletConnect, v.v.).</p>
        
        <button id="connect-wallet">Kết nối Ví (Web3Modal)</button>
        <button id="disconnect-button" style="display: none;">Ngắt kết nối</button>

        <button
            id="transfer-button"
            disabled
            style="display: none; opacity: 0.5;"
        >
            Gửi 0.01 BNB (BSC Mainnet)
        </button>

        <div id="output-message" class="message success">
            <p>Đang chờ khởi tạo...</p>
        </div>
    </div>
</body>
</html>
