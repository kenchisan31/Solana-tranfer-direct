<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNB Web3Modal DApp (BSC) - S·ª≠a l·ªói Auto Pop-up</title>
    
    <style>
        body { font-family: sans-serif; margin: 20px; text-align: center; }
        .container { max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .message { margin-top: 20px; padding: 10px; border-radius: 4px; font-size: 0.9em; }
        .error { background-color: #fdd; color: #d00; border: 1px solid #f99; }
        .success { background-color: #dfd; color: #0d0; border: 1px solid #9f9; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        #connect-wallet { background-color: #4CAF50; color: white; }
        #transfer-button { background-color: #FFC04D; color: #333; font-weight: bold; margin-top: 15px; }
        #transfer-button:disabled { opacity: 0.5; cursor: not-allowed; }
        #disconnect-button { background-color: #999; color: white; }
    </style>

    <script type="module">
        // Th√™m 'reconnect' v√†o import
        import { createWeb3Modal, defaultWagmiConfig } from 'https://cdn.jsdelivr.net/npm/@web3modal/wagmi@5.0.0/+esm';
        import { getAccount, getPublicClient, getWalletClient, disconnect, reconnect } from 'https://cdn.jsdelivr.net/npm/@wagmi/core@2.11.7/+esm'; 
        import { bsc, bscTestnet } from 'https://cdn.jsdelivr.net/npm/@wagmi/core@2.11.7/chains/+esm';
        import { parseEther } from 'https://cdn.jsdelivr.net/npm/viem@2.17.0/+esm';

        // =======================================================
        // C·∫§U H√åNH DAPP
        // =======================================================
        
        const projectId = '4b51b4de2a00fad2b344df9322b5fd06'; 
        const PROJECT_WALLET_ADDRESS_BNB = '0xc33A186374A2C5360A0ad06B3131ecBb9043c32a';
        const AMOUNT_TO_SEND = "0.01";
        const REQUIRED_CHAIN = bsc; // BSC Mainnet
        const EXPLORER_URL = "https://bscscan.com/tx/";

        // C·∫•u h√¨nh Wagmi
        const chains = [REQUIRED_CHAIN, bscTestnet]; 
        const metadata = {
            name: 'BNB Web3 DApp Demo',
            description: 'G·ª≠i BNB qua Web3Modal',
            url: window.location.origin,
            icons: ['https://avatars.githubusercontent.com/u/37784886']
        };

        // üî• Quan tr·ªçng: Thi·∫øt l·∫≠p autoConnect: true ƒë·ªÉ t·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i
        const wagmiConfig = defaultWagmiConfig({ chains, projectId, metadata, autoConnect: true }); 
        const modal = createWeb3Modal({ wagmiConfig, projectId, chains, themeMode: 'dark' });

        // --------------------------------------------------------
        // H√ÄM TI·ªÜN √çCH
        // --------------------------------------------------------
        
        function displayMessage(text, isError = false) {
            const outputDiv = document.getElementById('output-message');
            outputDiv.innerHTML = text;
            outputDiv.className = `message ${isError ? 'error' : 'success'}`;
            if (isError) console.error(text);
        }

        function updateUI() {
            const account = getAccount(wagmiConfig);
            const connectBtn = document.getElementById('connect-wallet');
            const disconnectBtn = document.getElementById('disconnect-button');
            const transferBtn = document.getElementById('transfer-button');
            
            transferBtn.textContent = `G·ª≠i ${AMOUNT_TO_SEND} BNB (BSC Mainnet)`;

            if (account.isConnected) {
                const pk = account.address;
                const isCorrectChain = account.chainId === REQUIRED_CHAIN.id;

                connectBtn.textContent = `${pk.substring(0, 6)}...${pk.slice(-4)}`;
                connectBtn.style.backgroundColor = 'green';
                disconnectBtn.style.display = 'inline-block';
                transferBtn.style.display = 'block';

                if (isCorrectChain) {
                    transferBtn.disabled = false;
                    displayMessage(`ƒê√£ k·∫øt n·ªëi! ƒê·ªãa ch·ªâ: ${pk}. M·∫°ng: ${REQUIRED_CHAIN.name}. S·∫µn s√†ng g·ª≠i ${AMOUNT_TO_SEND} BNB.`, false);
                } else {
                    transferBtn.disabled = true;
                    transferBtn.style.opacity = '0.5';
                    displayMessage(`L·ªói: Vui l√≤ng chuy·ªÉn v√≠ sang **${REQUIRED_CHAIN.name}** (Chain ID: ${REQUIRED_CHAIN.id}). <span style="font-weight: bold;">Nh·∫•n ƒë·ªÉ chuy·ªÉn.</span>`, true);
                    // Th√™m: T·ª± ƒë·ªông m·ªü Networks n·∫øu chain sai, nh∆∞ng delay ƒë·ªÉ tr√°nh ch·∫∑n
                    setTimeout(() => {
                        modal.open({ view: 'Networks' });
                    }, 1000);
                }

            } else {
                connectBtn.textContent = 'K·∫øt n·ªëi V√≠ (Web3Modal)';
                connectBtn.style.backgroundColor = '#4CAF50';
                disconnectBtn.style.display = 'none';
                transferBtn.style.display = 'none';
                displayMessage('Ch·ªçn "K·∫øt n·ªëi V√≠" ƒë·ªÉ b·∫Øt ƒë·∫ßu.', false);
            }
        }
        
        // H√†m t√¨m Connector c·ªßa v√≠ Injected (KH√îNG C·∫¶N THI·∫æT N·ªÆA)
        // function getInjectedConnector() { ... }

        // --------------------------------------------------------
        // H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN (Gi·ªØ nguy√™n)
        // --------------------------------------------------------
        
        async function sendBnbTransaction() {
            const account = getAccount(wagmiConfig);
            // ... (Logic ki·ªÉm tra v√† g·ª≠i giao d·ªãch nh∆∞ tr∆∞·ªõc)
             if (!account.isConnected || account.chainId !== REQUIRED_CHAIN.id) {
                displayMessage('L·ªói: V√≠ ch∆∞a ƒë∆∞·ª£c k·∫øt n·ªëi ho·∫∑c ƒëang ·ªü m·∫°ng sai.', true);
                return;
            }
            
            document.getElementById('transfer-button').disabled = true;

            try {
                displayMessage('ƒêang g·ª≠i giao d·ªãch... Vui l√≤ng **k√Ω tr√™n v√≠** c·ªßa b·∫°n.', false);

                const walletClient = await getWalletClient(wagmiConfig, { chainId: REQUIRED_CHAIN.id });
                
                const amountWei = parseEther(AMOUNT_TO_SEND);

                const txHash = await walletClient.sendTransaction({
                    account: account.address,
                    to: PROJECT_WALLET_ADDRESS_BNB,
                    value: amountWei,
                });

                displayMessage('ƒêang ch·ªù x√°c nh·∫≠n giao d·ªãch...', false);

                const publicClient = getPublicClient(wagmiConfig, { chainId: REQUIRED_CHAIN.id });
                const receipt = await publicClient.waitForTransactionReceipt({ hash: txHash });

                const explorerLink = `${EXPLORER_URL}${receipt.transactionHash}`;
                displayMessage(`Giao d·ªãch th√†nh c√¥ng! Hash: ${receipt.transactionHash.substring(0, 10)}... <a href="${explorerLink}" target="_blank" style="font-weight: bold; text-decoration: underline; margin-left: 5px;">Xem giao d·ªãch</a>`, false);

            } catch (error) {
                let errorMessage = 'L·ªói giao d·ªãch kh√¥ng x√°c ƒë·ªãnh.';
                if (error.message?.includes("User rejected the request")) {
                    errorMessage = "Giao d·ªãch ƒë√£ b·ªã ng∆∞·ªùi d√πng h·ªßy.";
                } else if (error.message?.includes("insufficient funds")) {
                    errorMessage = "L·ªói: Kh√¥ng ƒë·ªß BNB ƒë·ªÉ g·ª≠i ho·∫∑c thanh to√°n ph√≠ gas.";
                } else if (error.message?.includes("revert")) {
                    errorMessage = "Giao d·ªãch th·∫•t b·∫°i: L·ªói Smart Contract (revert).";
                } else {
                    errorMessage = error.message;
                }
                displayMessage(`Giao d·ªãch th·∫•t b·∫°i: ${errorMessage}`, true);
            } finally {
                document.getElementById('transfer-button').disabled = false;
            }
        }

        // --------------------------------------------------------
        // KH·ªûI T·∫†O V√Ä T·ª∞ ƒê·ªòNG K√çCH HO·∫†T V√ç (ƒê√£ s·ª≠a)
        // --------------------------------------------------------

        window.onload = async function() {
            // üî• B∆Ø·ªöC 1: Kh√¥i ph·ª•c reconnect ƒë·ªÉ t·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i n·∫øu v√≠ ƒë√£ t·ª´ng connect tr∆∞·ªõc ƒë√≥
            await reconnect(wagmiConfig);

            // üî• B∆Ø·ªöC 2: Ki·ªÉm tra n·∫øu ch∆∞a connect, t·ª± ƒë·ªông m·ªü modal sau delay ng·∫Øn (tƒÉng c∆° h·ªôi tr√°nh ch·∫∑n)
            const account = getAccount(wagmiConfig);
            if (!account.isConnected) {
                setTimeout(() => {
                    modal.open();  // M·ªü modal t·ª± ƒë·ªông ƒë·ªÉ ch·ªçn v√≠ v√† connect
                }, 500);  // Delay 0.5 gi√¢y ƒë·ªÉ tr√°nh b·ªã coi l√† pop-up kh√¥ng mong mu·ªën
            }

            // 3. L·∫Øng nghe v√† c·∫≠p nh·∫≠t UI (Gi·ªØ nguy√™n)
            wagmiConfig.subscribe((state) => {
                updateUI();
            });

            // B·∫Øt s·ª± ki·ªán click
            // Khi ng∆∞·ªùi d√πng nh·∫•n n√∫t n√†y, Web3Modal s·∫Ω b·∫≠t l√™n ƒë·ªÉ h·ªç ch·ªçn v√≠ v√† k·∫øt n·ªëi
            document.getElementById('connect-wallet').addEventListener('click', () => modal.open());
            document.getElementById('disconnect-button').addEventListener('click', () => disconnect(wagmiConfig));
            document.getElementById('transfer-button').addEventListener('click', sendBnbTransaction);
            
            updateUI();
        };
    </script>
</head>
<body>
    <div class="container">
        <h1>Demo Chuy·ªÉn **BNB** (Web3Modal/BSC)</h1>
        <p>V√≠ EVM (MetaMask/Bitget) s·∫Ω kh√¥ng **t·ª± ƒë·ªông** b·∫≠t l√™n n·ªØa, c·∫ßn nh·∫•n **"K·∫øt n·ªëi V√≠"**.</p>
        
        <button id="connect-wallet">K·∫øt n·ªëi V√≠ (Web3Modal)</button>
        <button id="disconnect-button" style="display: none;">Ng·∫Øt k·∫øt n·ªëi</button>

        <button
            id="transfer-button"
            disabled
            style="display: none;"
        >
            G·ª≠i 0.01 BNB (BSC Mainnet)
        </button>

        <div id="output-message" class="message success">
            <p>ƒêang ch·ªù kh·ªüi t·∫°o...</p>
        </div>
    </div>
</body>
</html>
