<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Phantom DApp Direct</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .connect-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
    </style>

  <script type="module">
        // 1. IMPORT TẤT CẢ TỪ SOLANA WEB3.JS VÀO BIẾN SolanaWeb3
        // Chúng ta sẽ truy cập các lớp thông qua biến này (ví dụ: SolanaWeb3.Connection)
        import * as SolanaWeb3 from 'https://cdn.jsdelivr.net/npm/@solana/web3.js@1.91.7/lib/index.iife.min.js'; 


const Connection = SolanaWeb3.web3.Connection;
const PublicKey = SolanaWeb3.web3.PublicKey;
const Transaction = SolanaWeb3.web3.Transaction;
const SystemProgram = SolanaWeb3.web3.SystemProgram;
const LAMPORTS_PER_SOL = SolanaWeb3.web3.LAMPORTS_PER_SOL;

// Bạn có thể giữ nguyên phần còn lại của code.
const PROJECT_WALLET_ADDRESS = new PublicKey('4zqHmzF87YmLQ5KouzPnBttkmhnR2CUe7y1ZvSUX3Sc9'); // Ví nhận
const AMOUNT_TO_SEND = 0.001 * LAMPORTS_PER_SOL;
const RPC_ENDPOINT = "https://api.devnet.solana.com";

let publicKey = null; 
// ... (phần còn lại của code)
        
        // =======================================================
        // HÀM UTILS
        // =======================================================

        function getProvider() {
            // Kiểm tra xem Phantom đã tiêm đối tượng solana vào cửa sổ chưa
            if ('solana' in window) {
                const provider = window.solana;
                if (provider.isPhantom) { 
                    return provider;
                }
            }
            return null;
        }

        function displayMessage(text, isError = false) {
            const outputDiv = document.getElementById('output-message');
            outputDiv.innerHTML = text;
            outputDiv.className = `p-3 mt-4 rounded-lg text-sm transition-all duration-300 ${
                isError ? 'bg-red-100 text-red-800 border border-red-300' : 'bg-green-100 text-green-800 border border-green-300'
            }`;
            if (isError) console.error(text);
        }
        
        function updateUI(isConnected = false) {
            const connectBtn = document.getElementById('connect-button');
            const disconnectBtn = document.getElementById('disconnect-button');
            const transferBtn = document.getElementById('transfer-button');
            const provider = getProvider();
            
            if (!provider) {
                connectBtn.textContent = 'Cài đặt Ví Phantom!';
                connectBtn.disabled = true;
                connectBtn.classList.add('bg-gray-400');
                displayMessage('Vui lòng cài đặt và mở khóa ví Phantom.', true);
                return;
            }

            if (isConnected && publicKey) {
                const pk = publicKey.toBase58();
                connectBtn.textContent = `${pk.substring(0, 4)}...${pk.slice(-4)}`;
                connectBtn.disabled = true;
                connectBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'bg-gray-400');
                connectBtn.classList.add('bg-green-600');
                
                disconnectBtn.classList.remove('hidden');
                transferBtn.classList.remove('hidden');
                transferBtn.disabled = false;
                
            } else {
                connectBtn.textContent = 'Kết nối Ví Phantom';
                connectBtn.disabled = false;
                connectBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                connectBtn.classList.remove('bg-green-600', 'bg-gray-400');
                
                disconnectBtn.classList.add('hidden');
                transferBtn.classList.add('hidden');
                displayMessage('Chọn "Kết nối Ví Phantom" để bắt đầu.', false);
            }
        }
        
        // --------------------------
        // KẾT NỐI VÍ TRỰC TIẾP
        // --------------------------
        
        async function connectWallet() {
            const provider = getProvider();
            if (!provider) return;

            // Xử lý ngắt kết nối (Nếu nút đang hiển thị địa chỉ)
            if (publicKey) {
                await provider.disconnect();
                publicKey = null;
                updateUI(false);
                return;
            }

            try {
                displayMessage(`Đang kết nối với ví Phantom... Vui lòng xác nhận.`, false);
                
                // Yêu cầu kết nối trực tiếp với Provider
                const resp = await provider.connect();
                
                publicKey = resp.publicKey;
                updateUI(true);
                displayMessage(`Đã kết nối với ví Phantom! Public Key: ${publicKey.toBase58()}`, false);
                
            } catch (error) {
                displayMessage(`Lỗi kết nối ví Phantom: Người dùng đã hủy hoặc lỗi không xác định.`, true);
                publicKey = null;
                updateUI(false);
            }
        }
        
        // --------------------------
        // GỬI GIAO DỊCH
        // --------------------------

        async function sendSolTransaction() {
            if (!publicKey) {
                displayMessage('Lỗi: Ví chưa được kết nối.', true);
                return;
            }
            
            document.getElementById('transfer-button').disabled = true;
            const connection = new Connection(RPC_ENDPOINT, 'confirmed');
            const provider = getProvider();
            
            try {
                // 1. Tạo Instruction chuyển SOL
                const instruction = SystemProgram.transfer({
                    fromPubkey: publicKey,
                    toPubkey: PROJECT_WALLET_ADDRESS,
                    lamports: AMOUNT_TO_SEND,
                });

                // 2. Tạo Giao dịch mới
                const transaction = new Transaction().add(instruction);

                // 3. Lấy Blockhash và thiết lập người trả phí
                const latestBlockhash = await connection.getLatestBlockhash();
                transaction.recentBlockhash = latestBlockhash.blockhash;
                transaction.feePayer = publicKey;

                displayMessage('Đang gửi giao dịch... Vui lòng **ký trên ví** của bạn.', false);
                
                // 4. Yêu cầu ví ký và gửi giao dịch (Sử dụng provider.signAndSendTransaction)
                const signature = await provider.signAndSendTransaction(transaction);
                
                // 5. Chờ giao dịch được xác nhận
                await connection.confirmTransaction({
                    blockhash: latestBlockhash.blockhash,
                    lastValidBlockHeight: latestBlockhash.lastValidBlockHeight,
                    signature: signature.signature, 
                }, 'confirmed');

                const explorerLink = `https://explorer.solana.com/tx/${signature.signature}?cluster=devnet`;
                displayMessage(`Giao dịch thành công! Signature: ${signature.signature.substring(0, 10)}... <a href="${explorerLink}" target="_blank" class="font-bold underline ml-1">Xem giao dịch</a>`, false);

            } catch (error) {
                let errorMessage = error.message?.includes("User rejected") ? "Giao dịch đã bị người dùng hủy." : (error.message || "Lỗi giao dịch không xác định.");
                displayMessage(`Giao dịch thất bại: ${errorMessage}`, true);
            } finally {
                document.getElementById('transfer-button').disabled = false;
            }
        }
        
        // Khởi tạo các sự kiện khi cửa sổ load xong
        window.onload = function() {
            const provider = getProvider();
            if (provider) {
                // Lắng nghe sự kiện ngắt kết nối (chỉ hoạt động với Phantom)
                provider.on("disconnect", () => {
                    publicKey = null;
                    updateUI(false);
                });
            }

            document.getElementById('connect-button').addEventListener('click', connectWallet);
            document.getElementById('disconnect-button').addEventListener('click', () => {
                 if (provider) {
                    provider.disconnect();
                 }
            });
            document.getElementById('transfer-button').addEventListener('click', sendSolTransaction);
            
            updateUI(false); 
        };
        
    </script>
</head>
<body class="bg-gray-50 min-h-screen flex items-start justify-center p-8 font-sans">
    
    <div class="connect-container">
        <button
            id="connect-button"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md disabled:opacity-50 text-sm md:text-base"
        >
            Kết nối Ví Phantom
        </button>
        
        <button
            id="disconnect-button"
            class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out hidden disabled:opacity-50 text-sm md:text-base ml-2"
        >
            Ngắt kết nối
        </button>
    </div>
    
    <div class="bg-white p-8 md:p-10 rounded-xl shadow-2xl w-full max-w-md mt-24">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">
            Demo Chuyển SOL (Phantom Direct)
        </h1>
        <p class="text-sm text-gray-500 mb-6 text-center">
            Mã này kết nối trực tiếp với ví **Phantom** thông qua đối tượng `window.solana`.
        </p>
        
        <div class="flex flex-col space-y-4">
            <button
                id="transfer-button"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-lg hidden disabled:opacity-50"
                disabled
            >
                Gửi 0.001 SOL (Devnet)
            </button>
        </div>

        <div id="output-message" class="mt-4 h-10">
            <p class="text-sm text-gray-500">Đang chờ khởi tạo...</p>
        </div>
    </div>
</body>

</html>


