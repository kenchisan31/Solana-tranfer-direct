<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereum MetaMask DApp Direct</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .connect-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.12.0/dist/ethers.umd.min.js"></script>

    <script>
        // Lấy các thành phần từ Ethers.js
        const { ethers } = window;
        
        // =======================================================
        // CẤU HÌNH DAPP
        // =======================================================
        
        // THAY ĐỊA CHỈ NÀY BẰNG VÍ ETH CỦA BẠN (Sử dụng Devnet/Testnet như Sepolia)
        const PROJECT_WALLET_ADDRESS_ETH = '0xc33A186374A2C5360A0ad06B3131ecBb9043c32a'; // THAY ĐỔI
        const AMOUNT_TO_SEND = "0.01"; // Gửi 0.001 ETH
        const EXPLORER_URL = "https://sepolia.etherscan.io/tx/"; // Dành cho Sepolia Testnet

        let publicKey = null; // Địa chỉ ví đã kết nối (string)
        
        // =======================================================
        // HÀM UTILS CẦN THIẾT (BỊ THIẾU TRONG CODE CỦA BẠN)
        // =======================================================

        function getProvider() {
            // Kiểm tra xem ví EVM (MetaMask) đã tiêm đối tượng ethereum vào cửa sổ chưa
            if (typeof window.ethereum !== 'undefined') {
                return window.ethereum;
            }
            return null;
        }

        function displayMessage(text, isError = false) {
            const outputDiv = document.getElementById('output-message');
            outputDiv.innerHTML = text;
            outputDiv.className = `p-3 mt-4 rounded-lg text-sm transition-all duration-300 ${
                isError ? 'bg-red-100 text-red-800 border border-red-300' : 'bg-green-100 text-green-800 border border-green-300'
            }`;
            if (isError) console.error(text);
        }
        
        function updateUI(isConnected = false) {
            const connectBtn = document.getElementById('connect-button');
            const disconnectBtn = document.getElementById('disconnect-button');
            const transferBtn = document.getElementById('transfer-button');
            const provider = getProvider();
            
            if (!provider) {
                connectBtn.textContent = 'Cài đặt MetaMask!';
                connectBtn.disabled = true;
                connectBtn.classList.add('bg-gray-400');
                displayMessage('Vui lòng cài đặt và mở khóa ví MetaMask.', true);
                return;
            }

            if (isConnected && publicKey) {
                const pk = publicKey;
                connectBtn.textContent = `${pk.substring(0, 6)}...${pk.slice(-4)}`;
                connectBtn.disabled = true;
                connectBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'bg-gray-400');
                connectBtn.classList.add('bg-green-600');
                
                disconnectBtn.classList.remove('hidden');
                transferBtn.classList.remove('hidden');
                transferBtn.disabled = false;
                
            } else {
                connectBtn.textContent = 'Kết nối Ví MetaMask';
                connectBtn.disabled = false;
                connectBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                connectBtn.classList.remove('bg-green-600', 'bg-gray-400');
                
                disconnectBtn.classList.add('hidden');
                transferBtn.classList.add('hidden');
                displayMessage('Chọn "Kết nối Ví MetaMask" để bắt đầu.', false);
            }
        }
        
        // =======================================================
        // HÀM KẾT NỐI (ĐƯỢC SỬA)
        // =======================================================
        
        async function connectWallet() {
            const provider = getProvider();
            if (!provider) return;

            // Trong EVM, ngắt kết nối không thực sự ngắt quyền truy cập, 
            // nó chỉ làm sạch trạng thái DApp
            if (publicKey) {
                publicKey = null;
                updateUI(false);
                return;
            }

            try {
                displayMessage('Đang kết nối với ví EVM... Vui lòng xác nhận.', false);
                
                // Yêu cầu quyền truy cập tài khoản
                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                
                // Tạo một Ethers provider/signer để tương tác
                const ethersProvider = new ethers.BrowserProvider(provider);
                const signer = await ethersProvider.getSigner();

                publicKey = signer.address;
                updateUI(true);
                displayMessage(`Đã kết nối! Địa chỉ: ${publicKey}`, false);
                
            } catch (error) {
                displayMessage(`Lỗi kết nối ví EVM: Người dùng đã hủy hoặc lỗi không xác định.`, true);
                publicKey = null;
                updateUI(false);
            }
        }
        
        // =======================================================
        // HÀM GIAO DỊCH (ĐƯỢC SỬA)
        // =======================================================

        async function sendEthTransaction() {
            if (!publicKey) {
                displayMessage('Lỗi: Ví chưa được kết nối.', true);
                return;
            }
            
            if (PROJECT_WALLET_ADDRESS_ETH === '0x0000000000000000000000000000000000000000') {
                 displayMessage('Lỗi cấu hình: Vui lòng thay đổi địa chỉ ví nhận (PROJECT_WALLET_ADDRESS_ETH).', true);
                 return;
            }
            
            document.getElementById('transfer-button').disabled = true;
            
            const ethProvider = getProvider();
            const ethersProvider = new ethers.BrowserProvider(ethProvider);
            
            try {
                const signer = await ethersProvider.getSigner();
                
                // Chuyển đổi số lượng từ số thập phân ("0.001") sang BigInt (wei)
                const amountWei = ethers.parseEther(AMOUNT_TO_SEND); 

                displayMessage('Đang gửi giao dịch... Vui lòng **ký trên ví** của bạn.', false);
                
                // Tạo và gửi giao dịch
                const txResponse = await signer.sendTransaction({
                    to: PROJECT_WALLET_ADDRESS_ETH,
                    value: amountWei, 
                });

                // Chờ giao dịch được xác nhận
                const receipt = await txResponse.wait(); 

                const explorerLink = `${EXPLORER_URL}${receipt.hash}`;
                displayMessage(`Giao dịch thành công! Hash: ${receipt.hash.substring(0, 10)}... <a href="${explorerLink}" target="_blank" class="font-bold underline ml-1">Xem giao dịch</a>`, false);

            } catch (error) {
                let errorMessage = error.message?.includes("user rejected") ? "Giao dịch đã bị người dùng hủy." : (error.message || "Lỗi giao dịch không xác định.");
                displayMessage(`Giao dịch thất bại: ${errorMessage}`, true);
            } finally {
                document.getElementById('transfer-button').disabled = false;
            }
        }
        
        // =======================================================
        // KHỞI TẠO SỰ KIỆN (BỊ THIẾU TRONG CODE CỦA BẠN)
        // =======================================================
        window.onload = function() {
            const provider = getProvider();
            
            // Xử lý sự kiện thay đổi tài khoản hoặc mạng (chuẩn EVM)
            if (provider) {
                provider.on('accountsChanged', (accounts) => {
                    publicKey = accounts.length > 0 ? accounts[0] : null;
                    updateUI(publicKey !== null);
                });
                provider.on('chainChanged', (chainId) => {
                    displayMessage(`Mạng đã thay đổi sang Chain ID: ${chainId}`, false);
                    // Có thể cần refresh hoặc kết nối lại ở đây
                });
            }

            document.getElementById('connect-button').addEventListener('click', connectWallet);
            // Trong EVM, "Ngắt kết nối" thường chỉ là ngắt kết nối logic trong DApp
            document.getElementById('disconnect-button').addEventListener('click', () => {
                publicKey = null;
                updateUI(false);
            });
            document.getElementById('transfer-button').addEventListener('click', sendEthTransaction);
            
            updateUI(false); 
        };
        
    </script>
</head>
<body class="bg-gray-50 min-h-screen flex items-start justify-center p-8 font-sans">
    
    <div class="connect-container">
        <button
            id="connect-button"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md disabled:opacity-50 text-sm md:text-base"
        >
            Kết nối Ví **MetaMask**
        </button>
        
        <button
            id="disconnect-button"
            class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out hidden disabled:opacity-50 text-sm md:text-base ml-2"
        >
            Ngắt kết nối
        </button>
    </div>
    
    <div class="bg-white p-8 md:p-10 rounded-xl shadow-2xl w-full max-w-md mt-24">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">
            Demo Chuyển **ETH** (MetaMask/EVM Direct)
        </h1>
        <p class="text-sm text-gray-500 mb-6 text-center">
            Mã này kết nối trực tiếp với ví **EVM (MetaMask)** thông qua đối tượng `window.ethereum`.
        </p>
        
        <div class="flex flex-col space-y-4">
            <button
                id="transfer-button"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-lg hidden disabled:opacity-50"
                disabled
            >
                Gửi 0.01 ETH (Sepolia/Testnet)
            </button>
        </div>

        <div id="output-message" class="mt-4 h-10">
            <p class="text-sm text-gray-500">Đang chờ khởi tạo...</p>
        </div>
    </div>
</body>

</html>

